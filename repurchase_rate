select t3.t1month as Month,count(distinct t3.user_id) as Num_Customer,
count(distinct case when t3.diff=1 then t3.user_id else null end) as M1,
count(distinct case when t3.diff=2 then t3.user_id else null end) as M2,
count(distinct case when t3.diff=3 then t3.user_id else null end) as M3,
count(distinct case when t3.diff=4 then t3.user_id else null end) as M4,
count(distinct case when t3.diff=5 then t3.user_id else null end) as M5,
count(distinct case when t3.diff=6 then t3.user_id else null end) as M6,
count(distinct case when t3.diff=7 then t3.user_id else null end) as M7,
count(distinct case when t3.diff=8 then t3.user_id else null end) as M8,
count(distinct case when t3.diff=1 then t3.user_id else null end)/count(distinct t3.user_id) as rM1,
count(distinct case when t3.diff=2 then t3.user_id else null end)/count(distinct t3.user_id) as rM2,
count(distinct case when t3.diff=3 then t3.user_id else null end)/count(distinct t3.user_id) as rM3,
count(distinct case when t3.diff=4 then t3.user_id else null end)/count(distinct t3.user_id) as rM4,
count(distinct case when t3.diff=5 then t3.user_id else null end)/count(distinct t3.user_id) as rM5,
count(distinct case when t3.diff=6 then t3.user_id else null end)/count(distinct t3.user_id) as rM6,
count(distinct case when t3.diff=7 then t3.user_id else null end)/count(distinct t3.user_id) as rM7,
count(distinct case when t3.diff=8 then t3.user_id else null end)/count(distinct t3.user_id) as rM8
from
(select t1.user_id,t1month,t2month, t2month-t1month as diff
from 
((select user_id,month(order_date) as t1month
from `new_schema`.`testdata` 
where order_status=1
group by user_id, month(order_date)) as t1
left join 
(select user_id,month(order_date) as t2month
from `new_schema`.`testdata` 
where order_status=1
group by user_id, month(order_date)) as t2
on t1.user_id=t2.user_id)) as t3
group by  t3.t1month
